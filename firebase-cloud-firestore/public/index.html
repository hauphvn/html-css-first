<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Welcome to Firebase Hosting</title>

    <!-- update the version number as needed -->
    <script defer src="/__/firebase/6.6.2/firebase-app.js"></script>
    <!-- include only the Firebase features as you need -->
    <script defer src="/__/firebase/6.6.2/firebase-auth.js"></script>
    <script defer src="/__/firebase/6.6.2/firebase-database.js"></script>
    <script defer src="/__/firebase/6.6.2/firebase-messaging.js"></script>
    <script defer src="/__/firebase/6.6.2/firebase-storage.js"></script>
    <script defer src="/__/firebase/6.6.2/firebase-app.js"></script>
    <script defer src="/__/firebase/6.6.2/firebase-firestore.js"></script>
    <!-- initialize the SDK after all desired features are loaded -->
    <script defer src="/__/firebase/init.js"></script>

    <style media="screen">
      body { background: #ECEFF1; color: rgba(0,0,0,0.87); font-family: Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; }
      #message { background: white; max-width: 360px; margin: 100px auto 16px; padding: 32px 24px; border-radius: 3px; }
      #message h2 { color: #ffa100; font-weight: bold; font-size: 16px; margin: 0 0 8px; }
      #message h1 { font-size: 22px; font-weight: 300; color: rgba(0,0,0,0.6); margin: 0 0 16px;}
      #message p { line-height: 140%; margin: 16px 0 24px; font-size: 14px; }
      #message a { display: block; text-align: center; background: #039be5; text-transform: uppercase; text-decoration: none; color: white; padding: 16px; border-radius: 4px; }
      #message, #message a { box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24); }
      #load { color: rgba(0,0,0,0.4); text-align: center; font-size: 13px; }
      @media (max-width: 600px) {
        body, #message { margin-top: 0; background: white; box-shadow: none; }
        body { border-top: 16px solid #ffa100; }
      }
    </style>
  </head>
  <body>
  <div class="container">
    <div class="row">
      <h1>Demo REST api </h1>
      <table>
        <td>
          <div  style="border: 1px solid black;" class="col-sm-6 col-md-6">
            <h4>GET</h4>
            <ul id="tbUser"></ul>
          </div>
        </td>
        <td >
          <div class="col-sm-6 col-md-6" style="border: 1px solid gray;">
            <h4>POST</h4>
            <h5>Create a new user:</h5>
            <label for="firstname">First name:</label>
            <input type="text" id="firstname" placeholder="Tèo...">
            <br>
            <label for="lastname">Last name:</label>
            <input type="text" id="lastname" placeholder="Nguyễn văn...">
            <br>
            <label for="email">Email:</label>
            <input type="text" id="email" placeholder="nvteo@example.com">
            <br>
            <button type="button" id="btn-add">Add</button>
          </div>
        </td>
        <td>
          <div class="col-sm-6 col-md-6" style="border: 1px solid gray;">
            <h4>PUT</h4>
            <h5>Enter a first name to modify:</h5>
            <label for="updateFirstName">First Name</label>
            <input type="text" placeholder="tèo..." id="updateFirstName">
            <ul id="ulFilterUser"></ul>
            <h5>To update this user:</h5>
            <label for="firstname">First name:</label>
            <input type="text" id="upfirstname" placeholder="Tèo...">
            <br>
            <label for="lastname">Last name:</label>
            <input type="text" id="uplastname" placeholder="Nguyễn văn...">
            <br>
            <label for="email">Email:</label>
            <input type="text" id="upemail" placeholder="nvteo@example.com">
            <br>
            <button type="button" id="btn-update">Update</button>
          </div>
        </td>

        <td>
          <div class="col-sm-6 col-md-6" style="border: 1px solid gray;">
            <h4>DELETE</h4>
            <h5>Enter a first name to delete:</h5>
            <label for="dldateFirstName">First Name</label>
            <input type="text" placeholder="tèo..." id="dldateFirstName">
            <ul id="dlFilterUser"></ul>
            <h5>Do you want to delete this user:</h5>
            <label for="dlfirstname">First name:</label>
            <input type="text" id="dlfirstname" placeholder="Tèo...">
            <br>
            <label for="lastname">Last name:</label>
            <input type="text" id="dllastname" placeholder="Nguyễn văn...">
            <br>
            <label for="dlemail">Email:</label>
            <input type="text" id="dlemail" placeholder="nvteo@example.com">
            <br>
            <button type="button" id="btn-delete">Delete</button>
          </div>
        </td>

      </table>
    </div>
  </div>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        var db = firebase.firestore();
        // GET
        var dataUsers = [];
        let tbListUsers = document.getElementById('tbUser');
        getUser();//Load from server

        function renderListUser(dataUsers){
          let ulUsers = dataUsers.map(function (item) {
            return '<li>'+item.data().firstName+' '+item.data().lastName+  '-'+item.data().email+'</li>';
          });
          tbListUsers.innerHTML = ulUsers.join("");
        }
        async function getUser() {
          // try {
          //   const res = await axios.get('http://localhost:4000/users');
          //   dataUsers = res.data;
          //   renderListUser(dataUsers);//Render users to table
          // } catch (error) {
          //   console.error(error);
          // }
          await db.collection("users").get().then((querySnapshot) => {
            let docs = querySnapshot.docs;
            for (item of docs){
              dataUsers.push(item);
            }
            renderListUser(dataUsers);//Render users to table
          });
        }
        //
        // // POST
        let newFirstname = document.getElementById('firstname');
        let newLastname = document.getElementById('lastname');
        let newEmail = document.getElementById('email');
        let btnAdd = document.getElementById('btn-add');
        btnAdd.addEventListener('click',addingNewUser);


        function addingNewUser() {
          let tbListUsers = document.getElementById('tbUser');
          // axios({
          //   method:'post',
          //   url: 'http://localhost:4000/users',
          //   data:{
          //     // id: ++curId,
          //     firstName: newFirstname.value,
          //     lastName: newLastname.value,
          //     email: newEmail.value
          //   }
          // });

          db.collection("users").add({
                firstName: newFirstname.value,
                lastName: newLastname.value,
                email: newEmail.value
          })
                  .then(function(docRef) {
                    // console.log("Document written with ID: ", docRef.id);
                    alert("Adding success!");
                  })
                  .catch(function(error) {
                    // console.error("Error adding document: ", error);
                    alert("Adding fail!");
                  });

          // location.reload();
        }
        //
        // // PUT
        let ulFilterUser = document.getElementById('ulFilterUser');
        let inputSearchUpdate = document.getElementById('updateFirstName');
        let btnUpdate = document.getElementById('btn-update');
        btnUpdate.addEventListener('click', onUpdateUser);
        let upFName = document.getElementById('upfirstname');
        let upLName = document.getElementById('uplastname');
        let upEmail = document.getElementById('upemail');
        let idUser = "";
        inputSearchUpdate.addEventListener('keyup',function (event) {
          let value = (inputSearchUpdate.value).toLowerCase();
          let listFilterUsers = dataUsers.map(function (item) {
            if ((item.data().firstName).toLowerCase() === value){
              return '<li style="cursor: pointer;" idUser="'+item.id+'" fName="'+item.data().firstName+'" lName="'+item.data().lastName+'" email="'+item.data().email+'">'+item.data().firstName+' '+item.data().lastName+  '-'+item.data().email+'</li>';
            }
          });

          ulFilterUser.innerHTML = listFilterUsers.join("");
        });
        ulFilterUser.onclick = function(event) {
          var target = getEventTarget(event);
          idUser = (target.getAttribute('idUser'));
          upFName.value = target.getAttribute('fName');
          upLName.value = target.getAttribute('lName');
          upEmail.value = target.getAttribute('email');
        };
        //
        function onUpdateUser() {
          // axios.put(linkPUT, {
          //   firstName: upFName.value,
          //   lastName: upLName.value,
          //   email: upEmail.value
          // }).then(resp => {
          //   alert("Update success");
          //   console.log(resp.data);
          // }).catch(error => {
          //   alert("Update fail!");
          //   console.log(error);
          // });
          // var frankDocRef = db.collection("users").doc("frank");
          // frankDocRef.set({
          //   name: "Frank",
          //   favorites: { food: "Pizza", color: "Blue", subject: "recess" },
          //   age: 12
          // });
          var docRef = db.collection('users').doc(idUser);
          docRef.update({
            firstName: upFName.value,
            lastName: upLName.value,
            email: upEmail.value
          }).then(function () {
            alert("Document successfully updated!")
          });

        }

        function getEventTarget(e) {
          e = e || window.event;
          return e.target || e.srcElement;
        }
        //
        // // DELETE
        //
        let dlFilterUser = document.getElementById('dlFilterUser');
        let dlinputSearchUpdate = document.getElementById('dldateFirstName');
        let btnDelete = document.getElementById('btn-delete');
        btnDelete.addEventListener('click', onDeleteUser);
        let dlFName = document.getElementById('dlfirstname');
        let dlLName = document.getElementById('dllastname');
        let dlEmail = document.getElementById('dlemail');
        let idUserDelete = "";
        dlinputSearchUpdate.addEventListener('keyup',function (event) {
          let value = (dlinputSearchUpdate.value).toLowerCase();
          let dllistFilterUsers = dataUsers.map(function (item) {
            if ((item.data().firstName).toLowerCase() === value){
              return '<li style="cursor: pointer;" idUser="'+item.id+'" fName="'+item.data().firstName+'" lName="'+item.data().lastName+'" email="'+item.data().email+'">'+item.data().firstName+' '+item.data().lastName+  '-'+item.data().email+'</li>';
            }
          });
          dlFilterUser.innerHTML = dllistFilterUsers.join("");
        });
        dlFilterUser.onclick = function(event) {
          var target = dlgetEventTarget(event);
          idUserDelete = (target.getAttribute('idUser'));
          dlFName.value = target.getAttribute('fName');
          dlLName.value = target.getAttribute('lName');
          dlEmail.value = target.getAttribute('email');
        };

        function onDeleteUser() {
          // axios.delete(linkDelete).then(resp => {
          //   alert("Delete success");
          //   console.log(resp.data);
          // }).catch(error => {
          //   alert("Delete fail!");
          //   console.log(error);
          // });
          db.collection("users").doc(idUserDelete).delete().then(function () {
            alert("Document successfully deleted!");
          }).catch(function (err) {
            alert("Document finally deleted!");
            console.log("Error removing document: ", err);
          })
        }

        function dlgetEventTarget(e) {
          e = e || window.event;
          return e.target || e.srcElement;
        }


      });
    </script>
  </body>
</html>
